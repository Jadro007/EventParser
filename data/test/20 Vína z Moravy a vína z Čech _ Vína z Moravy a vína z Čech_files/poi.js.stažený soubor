SMap.POIServer=JAK.ClassMaker.makeClass({NAME:"SMap.POIServer",VERSION:"2.0",IMPLEMENT:[JAK.ISignals,SMap.IOwned,JAK.IDecorable]});SMap.POIServer.types={};SMap.POIServer.icons={};SMap.POIServer.prototype.$constructor=function(a,c){this._owner=null;this._url=a;this._ready=!1;this._defaultIcon=null;this._sources=[];this._types={};this._icons={};this._requestDetail=this._requestLookup=null};SMap.POIServer.prototype.isReady=function(){return this._ready};SMap.POIServer.prototype.getPath=function(){return this._url};
SMap.POIServer.prototype.getTypes=function(){var a=[],c;for(c in this._types)a.push(this._types[c].id);return a};SMap.POIServer.prototype.getPOIParams=function(){return this};SMap.POIServer.prototype.handlesSource=function(a){return!!this._url.match("poiagg")};SMap.POIServer.prototype.handlesType=function(a){for(var c=[],b=0;b<a.length;b++){var d=a[b];d in this._types&&c.push(d)}return c.length?c:!1};SMap.POIServer.prototype.getDescription=function(a,c,b){};
SMap.POIServer.prototype.getLookup=function(a,c){};SMap.POIServer.prototype.getDetail=function(a,c,b,d){};SMap.POIServer.prototype.overrideTypes=function(a){for(var c in a)if(c in this._types)for(var b in a[c])this._types[c][b]=a[c][b]};SMap.POIServer.prototype.getTypeImage=function(a,c){var b=SMap.POIServer;return a in b.types?b.types[a].url:this._defaultIcon};SMap.POIServer.XML=JAK.ClassMaker.makeClass({NAME:"SMap.POIServer.XML",VERSION:"1.0",EXTEND:SMap.POIServer});
SMap.POIServer.XML.prototype.$constructor=function(a,c){this.$super(a,c);this._options={request:JAK.Request,zoomCorrection:-2};for(var b in c)this._options[b]=c[b]};SMap.POIServer.XML.prototype.getPOIParams=function(){var a=new this._options.request(JAK.Request.XML);a.setCallback(this,"_responsePoiparams");a.send(this._url+"/poiparams");return this};
SMap.POIServer.XML.prototype.getDescription=function(a,c,b){var d=new this._options.request(JAK.Request.XML),e=this._url+"/description",f=c&&c.query?c.guery:null;d.setCallback(this,function(c,d){var e=this._responseDescription(c,d,a,f);b(e)});d.send(e,this._buildDescription(a,c))};
SMap.POIServer.XML.prototype.getLookup=function(a,c){this._requestLookup&&this._requestLookup.abort();this._requestLookup=new this._options.request(JAK.Request.XML);var b=this._buildLookup(a);this._requestLookup.setCallback(this,function(a,b){this._requestLookup=null;a&&this._enrichLookupResponse(a);c(a,b)});this._requestLookup.send(b)};
SMap.POIServer.XML.prototype.getDetail=function(a,c,b,d){this._requestDetail&&this._requestDetail.abort();this._requestDetail=new this._options.request(JAK.Request.XML);a=this._url+"/detail?"+this._buildDetail(a,c,d);this._requestDetail.setCallback(this,function(a,c){this._responseDetail(a,c,b)});this._requestDetail.send(a)};
SMap.POIServer.XML.prototype._enrichLookupResponse=function(a){a=a.getElementsByTagName("poi");for(var c=0;c<a.length;c++){var b=a[c],d=b.getAttribute("type"),e=this._types[d];e&&e.img&&b.setAttribute("url",this.getTypeImage(d))}};
SMap.POIServer.XML.prototype._responsePoiparams=function(a,c){if(a){if(!this._sources.length)for(var b=a.getElementsByTagName("source"),d=0;d<b.length;d++)this._sources.push(b[d].getAttribute("name"));b=a.getElementsByTagName("type");for(d=0;d<b.length;d++)this._parseType(b[d]);b=a.getElementsByTagName("fix");for(d=0;d<b.length;d++)this._fixes.push(b[d].getAttribute("option"));this._ready=!0}this.getMap().getSignals().makeEvent("poiparams",this)};
SMap.POIServer.XML.prototype._parseType=function(a){var c=a.getAttribute("id");a={name:a.getAttribute("name"),img:a.getAttribute("img"),id:c};this._types[c]=a};SMap.POIServer.XML.prototype.setType=function(a,c,b){if(c in this._types)throw Error("Can't overwrite POI type");this._types[a]={name:a,img:b||"",id:c}};
SMap.POIServer.XML.prototype._responseDescription=function(a,c,b,d){c={};if(!a)return c;a=a.getElementsByTagName("poi");for(b=0;b<a.length;b++){var e=a[b],f=e.getAttribute("source")+e.getAttribute("id"),e={title:this._emphasize(e,d),address:JAK.XML.textContent(e.getElementsByTagName("address")[0]),description:JAK.XML.textContent(e.getElementsByTagName("description")[0])};a[b].getAttribute("x")&&a[b].getAttribute("y")&&(e.x=a[b].getAttribute("x"),e.y=a[b].getAttribute("y"));c[f]=e}return c};
SMap.POIServer.XML.prototype._responseDetail=function(a,c,b){this._requestDetail=null;a&&b(a)};SMap.POIServer.XML.prototype._emphasize=function(a,c){var b=a.getElementsByTagName("title")[0],b=JAK.XML.textContent(b);if(!c)return b;var d=c.toLowerCase(),e=b.toLowerCase().indexOf(d);return-1==e?b:b.substring(0,e)+"<em>"+b.substring(e,e+d.length)+"</em>"+b.substring(e+d.length)};SMap.POIServer.XML.prototype._buildDescription=function(a,c){var b={id:""},d;for(d in a)b.id+=a[d].join(",");return b};
SMap.POIServer.XML.prototype._buildDetail=function(a,c,b){return"id="+c};SMap.POIServer.XML.prototype._buildLookup=function(a){var c=this._url+"/lookup?zoom={z}&type={types}&bbox={lx},{by},{rx},{ty}",b={z:this.getMap().getZoom()+this._options.zoomCorrection};a instanceof Array&&(b.types=a.join(","));return this.getMap().formatString(c,b)};
SMap.POIServer.XML.prototype._buildLookupClusters=function(a){var c=this._url+"/lookup?zoom="+this._clusterZoom+"&count="+this._clusterCount+"&type={types}&bbox={lx},{by},{rx},{ty}";a={types:a.join(",")};return this.getMap().formatString(c,a)};SMap.POIServer.XML.prototype.getTypeImage=function(a){return a in this._types?this._url+"/img/"+this._types[a].img:this._defaultIcon};SMap.POIServer.FRPC=JAK.ClassMaker.makeClass({NAME:"SMap.POIServer.FRPC",VERSION:"1.0",EXTEND:SMap.POIServer});
SMap.POIServer.FRPC.prototype.$constructor=function(a,c){this.$super(a,c);this._options={zoomCorrection:-2,lang:[]};for(var b in c)this._options[b]=c[b]};SMap.POIServer.FRPC.prototype.getPOIParams=function(){var a=new JAK.RPC(JAK.RPC.AUTO,{endpoint:this._url});a.setCallback(this,"_responsePoiicons");a.setErrorCallback(this,"_responsePoiicons");a.send("poiicons",[]);return this};
SMap.POIServer.FRPC.prototype.getDescription=function(a,c,b,d){var e=new JAK.RPC(JAK.RPC.AUTO,{endpoint:this._url}),f=c&&c.query?c.guery:null,g=function(a,b){d(b)};e.setCallback(this,function(c,d){var e=this._responseDescription(c,d,a,f);b(e,d,c)});d&&e.setErrorCallback(this,g);c=this._buildDescriptionArguments(a,c);e.send("description",c)};
SMap.POIServer.FRPC.prototype.getLookup=function(a,c){this._requestLookup&&this._requestLookup.abort();this._requestLookup=new JAK.RPC(JAK.RPC.AUTO,{endpoint:this._url});this._requestLookup.setCallback(this,function(a,b){this._requestLookup=null;200==b&&this._enrichLookupResponse(a);c(a,b)});this._requestLookup.setErrorCallback(this,function(a,b){c({},b)});var b=this._buildLookupArguments(a);this._requestLookup.send("lookupbox",b,{0:"float",1:"float",2:"float",3:"float","4.pixelSize":"float"})};
SMap.POIServer.FRPC.prototype.getDetail=function(a,c,b,d){this._requestDetail&&this._requestDetail.abort();"coor"==a?(a=c.split(","),c=SMap.Coords.fromWGS84(a[0],a[1]),a={status:200,poi:{mark:{lon:parseFloat(a[0]),lat:parseFloat(a[1])},title:c.toWGS84(3).reverse().join(" ")}},b(a)):(this._requestDetail=new JAK.RPC(JAK.RPC.AUTO,{endpoint:this._url}),a=this._buildDetailArguments(a,c,d),this._requestDetail.setCallback(this,function(a,c){this._responseDetail(a,c,b)}),this._requestDetail.send("detail",
a))};SMap.POIServer.FRPC.prototype.getMedia=function(a,c,b,d){this._requestMedia&&this._requestMedia.abort();this._requestMedia=new JAK.RPC(JAK.RPC.AUTO,{endpoint:this._url});this._requestMedia.setCallback(this,function(a,c){this._requestMedia=null;b(a,c)});this._requestMedia.send("getMedia",[a,c,{}])};
SMap.POIServer.FRPC.prototype._enrichLookupResponse=function(a){var c=SMap.POIServer;a=a.poi||[];for(var b=0;b<a.length;b++){var d=a[b];if(!d.url&&(d.url=this.getTypeImage(d.typeId,d.id),d&&d.url&&d.url.match(new RegExp("^"+SMap.CONFIG.poiimg+"/icon/"))&&(d.url2x=d.url+"?scale=2"),d.typeId in c.types)){var e=c.types[d.typeId];d.size=[e.width,e.height]}}};
SMap.POIServer.FRPC.prototype._responsePoiicons=function(a,c){var b=SMap.POIServer;200==c&&200==a.status&&(a.poiicon.forEach(function(a){a.url=SMap.CONFIG.poiimg+"/icon/"+a.id;b.icons[a.id]=a}),a.poitype.forEach(function(a){a.icon_id in b.icons&&(b.types[a.id]=b.icons[a.icon_id])}.bind(this)));this._ready=!0;this.getMap().getSignals().makeEvent("poiparams",this)};
SMap.POIServer.FRPC.prototype._responseDescription=function(a,c,b,d){var e={};if(200!=c)return e;a=a.poi||a.pois;for(c=0;c<a.length;c++){var f=a[c];f.title=this._emphasize(f.title,d);f.mark&&(f.x=f.mark.lon,f.y=f.mark.lat);f.address=this._buildDescriptionAddress(f);e[f.source+f.id]=f}(b.coor||[]).forEach(function(a){var b=a.split(","),b=SMap.Coords.fromWGS84(b[0],b[1]);e["coor"+a]={title:b.toWGS84(3).reverse().join(" ")}});return e};
SMap.POIServer.FRPC.prototype._buildDescriptionAddress=function(a){a=a.extend&&a.extend.address;if(!a)return null;if(a.lines&&a.lines.length)return a.lines;var c=[],b=!0;if(a.street&&a.quarter&&a.ward){var d=a.quarter.replace(a.city,"").replace("\u010dtvr\u0165",""),e=a.ward.replace(a.city,"").replace(a.quarter,""),f=/\-/i;""!=e&&(e=f.test(e)?e.replace("-"," - "):" - "+e);c.push(a.city+d+" "+e)}else a.street&&!a.quarter&&a.ward?(e=a.ward.replace(a.city,""),f=/\-/i,""!=e&&(e=f.test(e)?e.replace("-",
" - "):" - "+e),c.push(a.city+e)):a.street&&!a.ward&&a.house_num&&a.city?(c.push(a.street+" "+a.house_num),c.push(a.city),b=!1):a.city&&c.push(a.city);a.district&&b&&c.push(a.district);a.street||a.ward||a.address||a.house_num||!a.region||c.push(a.region);a.country&&"\u010cesk\u00e1 republika"!=a.country&&c.push(a.country);return c};SMap.POIServer.FRPC.prototype._responseDetail=function(a,c,b){this._requestDetail=null;b(a,c)};
SMap.POIServer.FRPC.prototype._emphasize=function(a,c){if(!c)return a;var b=c.toLowerCase(),d=a.toLowerCase().indexOf(b);return-1==d?a:a.substring(0,d)+"<em>"+a.substring(d,d+b.length)+"</em>"+a.substring(d+b.length)};SMap.POIServer.FRPC.prototype._buildDescriptionArguments=function(a,c){var b={},d;for(d in a)if("coor"!=d){b[d]=[];for(var e=a[d],f=0;f<e.length;f++)b[d].push(parseInt(e[f]))}c.adranum&&(b.adranum=parseInt(c.adranum));return c.additionalInfo?[b,c.additionalInfo]:[b]};
SMap.POIServer.FRPC.prototype._buildDetailArguments=function(a,c,b){a=[a,parseInt(c)];b&&a.push(b);return a};
SMap.POIServer.FRPC.prototype._buildLookupArguments=function(a){var c=this.getMap(),b=c.formatString("{zoom},{lx},{by},{rx},{ty}").split(","),d=(new SMap.Pixel(1,0)).toCoords(c).distance(c.getCenter()),e=parseInt(b[0]),c=parseFloat(b[1]),f=parseFloat(b[2]),g=parseFloat(b[3]),b=parseFloat(b[4]),d={zoom:e+this._options.zoomCorrection,pixelSize:d,lang:this._options.lang.length?this._options.lang:[Loader.lang]};a instanceof Array?d.type=a:d.mapsetId=a;return[c,f,g,b,d]};
SMap.DataProvider=JAK.ClassMaker.makeClass({NAME:"SMap.DataProvider",VERSION:"1.0",IMPLEMENT:[SMap.IOwned]});SMap.DataProvider.prototype.$constructor=function(){this._active=!1;this._layers=[];this._sc=[];this._mapSet=null;this._types={};this._poiservers=[];this._poiserverTypes=[];this._responses=[];this._remainingCount=this._waitingPoiservers=0;this._responsePoiserver=this._responsePoiserver.bind(this)};SMap.DataProvider.prototype.$destructor=function(){this.getMap().getSignals().removeListeners(this._sc)};
SMap.DataProvider.prototype.isActive=function(){return this._active};SMap.DataProvider.prototype.enable=function(){if(!this._active){this._active=!0;for(var a=0;a<this._layers.length;a++)this._layers[a].enable();this._waitingPoiservers||this._request(!1);return this}};SMap.DataProvider.prototype.disable=function(){if(this._active){this._active=!1;for(var a=0;a<this._layers.length;a++)this._layers[a].disable();return this}};
SMap.DataProvider.prototype.addPOIServer=function(a){if(-1!=this._poiservers.indexOf(a))return this;this._poiservers.push(a);if(a.isReady())return this._computeTypes(),this;var c=this.getMap().getSignals();this._waitingPoiservers++;this._sc.push(c.addListener(this,"poiparams","_poiparams",a));return this};SMap.DataProvider.prototype.removePOIServer=function(a){a=this._poiservers.indexOf(a);if(0>a)return null;var c=this._poiservers.splice(a,1);this._poiserverTypes.splice(a,1);return c[0]};
SMap.DataProvider.prototype.clearPOIServers=function(){this._poiservers=[];return this};SMap.DataProvider.prototype.setMapSet=function(a){this._mapSet=a;this._computeTypes();this._request(!1);return this};SMap.DataProvider.prototype.forceRequest=function(a){this._request(a)};SMap.DataProvider.prototype._mapRedraw=function(a){this._request(a.data.full)};
SMap.DataProvider.prototype._request=function(a){if(!this._waitingPoiservers&&this._active){this._responses=[];for(var c=0,b=0;b<this._poiservers.length;b++)c+=this._poiserverTypes[b].length;if((c||this._mapSet)&&this._poiservers.length)for(a&&this._clear(),b=this._remainingCount=0;b<this._poiservers.length;b++){if(a=this._poiserverTypes[b],a.length||this._mapSet)this._remainingCount++,this._poiservers[b].getLookup(this._mapSet||a,this._responsePoiserver)}else for(b=0;b<this._layers.length;b++)this._layers[b].removeAll()}};
SMap.DataProvider.prototype._clear=function(){for(var a=0;a<this._layers.length;a++)this._layers[a].clear()};SMap.DataProvider.prototype._responsePoiserver=function(a){this._remainingCount--;this._responses.push(a);this._remainingCount||this._done()};SMap.DataProvider.prototype._done=function(){for(var a=0;a<this._layers.length;a++)this._layers[a].fillFromData(this._responses);this._responses=[];this.getMap().getSignals().makeEvent("markers-ready",this)};
SMap.DataProvider.prototype._poiparams=function(a){this._waitingPoiservers--;this._waitingPoiservers||(this._computeTypes(),this._request(!1))};SMap.DataProvider.prototype._computeTypes=function(){var a=[],c;for(c in this._types)if(0<this._types[c]){var b=parseInt(c);a.push(isNaN(b)?c:b)}this._poiserverTypes=[];for(c=0;c<this._poiservers.length;c++)b=this._poiservers[c].handlesType(a)||[],this._poiserverTypes.push(b)};SMap.DataProvider.prototype.addLayer=function(a){this._layers.push(a);return this};
SMap.DataProvider.prototype.syncTypes=function(){};SMap.DataProvider.prototype.setOwner=function(a){this._owner=a;a=this.getMap().getSignals();this._sc.push(a.addListener(this,"map-redraw","_mapRedraw"));return this};SMap.DataProvider.prototype.enableTypes=function(a){for(var c=0;c<a.length;c++){var b=a[c];b in this._types||(this._types[b]=0);this._types[b]++}this._computeTypes();this._request(!1);return this};
SMap.DataProvider.prototype.disableTypes=function(a){for(var c=0;c<a.length;c++){var b=a[c];if(!(b in this._types))throw Error("Cannot disable type "+b+", not present");this._types[b]--}this._computeTypes();this._request(!1);return this};SMap.Layer.Lookup=JAK.ClassMaker.makeClass({NAME:"SMap.Layer.Lookup",VERSION:"1.0",EXTEND:SMap.Layer.Multi});
SMap.Layer.Lookup.prototype.$constructor=function(a){this.$super(a);this._markerLayers={};this._geometryLayers={};this._filters={marker:[],geometry:[]};this._oldMarkers={};this._newData={marker:{},geometry:{}}};SMap.Layer.Lookup.prototype.addMarkerLayer=function(a,c,b){return this._addLayer("marker",a,c,b)};SMap.Layer.Lookup.prototype.addGeometryLayer=function(a,c,b){return this._addLayer("geometry",a,c,b)};
SMap.Layer.Lookup.prototype._addLayer=function(a,c,b,d){this["_"+a+"Layers"][c.getId()]=c;this._filters[a].push({sources:b,types:d,layerId:c.getId()});this.addLayer(c)};
SMap.Layer.Lookup.prototype.fillFromData=function(a){var c=[],b;for(b in this._markerLayers)this._oldMarkers[b]=this._markerLayers[b].getMarkers(),this._newData.marker[b]=[];for(b in this._geometryLayers)this._newData.geometry[b]=[];var d=a instanceof Array?a:[a];for(a=0;a<d.length;a++){var e=d[a];e.nodeType?this._parseXML(e):this._parseData(e)}for(b in this._oldMarkers)d=this._markerLayers[b],d.removeMarker(this._oldMarkers[b],!0);for(b in this._geometryLayers)this._geometryLayers[b].removeAll();
for(b in this._newData.marker)d=this._markerLayers[b],a=this._newData.marker[b],d.addMarker(a),c=c.concat(a.filter(function(a){return"bubble"==a.getVisual().highlight}));for(b in this._newData.geometry)for(d=this._geometryLayers[b],e=this._newData.geometry[b],e.sort(function(a,b){var c=a.isPoint(),d=b.isPoint();return c==d?0:c?1:-1}),a=0;a<e.length;a++)d.addGeometry(e[a]);c.forEach(function(a){a.getContainer()[SMap.LAYER_MARKER].querySelector("span").style.visibility="hidden"});window.setTimeout(function(){c.forEach(function(a){a=
a.getContainer()[SMap.LAYER_MARKER].querySelector("span");a.style.visibility="visible";a.classList.remove("bounceIn");a.offsetWidth;a.classList.add("bounceIn");c=[]})},500)};
SMap.Layer.Lookup.prototype._parseXML=function(a){for(var c=a.getElementsByTagName("poi"),b=0;b<c.length;b++){var d=c[b],e=d.getAttribute("source"),f=d.getAttribute("type");if(f=this._findLayer("marker",e,f))e+=d.getAttribute("id"),this._checkMarker(e,f)||(e=SMap.LOOKUP_MARKER[d.getAttribute("source")]||SMap.Marker,d=e.fromXML(d),this._newData.marker[f].push(d))}a=a.getElementsByTagName("geometry");for(b=0;b<a.length;b++)if(d=a[b],e=d.getAttribute("source"),f=d.getAttribute("type"),f=this._findLayer("geometry",
e,f))e=SMap.LOOKUP_GEOMETRY[d.getAttribute("source")]||SMap.Geometry.Multi,c=e.fromXML(d),this._newData.geometry[f].push(c)};
SMap.Layer.Lookup.prototype._parseData=function(a){a=a.poi||[];for(var c=0;c<a.length;c++){var b=a[c],d=b.source,e=b.typeId;if(b.geom){if(e=this._findLayer("geometry",d,e))d=SMap.LOOKUP_GEOMETRY[b.source]||SMap.Geometry.Multi,b=d.fromData(b),this._newData.geometry[e].push(b)}else(e=this._findLayer("marker",d,e))&&!this._checkMarker(d+b.id,e)&&(d=SMap.LOOKUP_MARKER[b.source]||SMap.Marker.POI,b=d.fromData(b),this._newData.marker[e].push(b))}};
SMap.Layer.Lookup.prototype._findLayer=function(a,c,b){a=this._filters[a];for(var d=0;d<a.length;d++){var e=a[d],f=!e.sources||-1!=e.sources.indexOf(c),g=!e.types||-1!=e.types.indexOf(b);if(f&&g)return e.layerId}};SMap.Layer.Lookup.prototype._checkMarker=function(a,c){for(var b=this._oldMarkers[c],d=0;d<b.length;d++)if(b[d].getId()==a)return b.splice(d,1),!0;return!1};SMap.Marker.POI=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.POI",VERSION:"1.0",EXTEND:SMap.Marker});SMap.Marker.POI.nodeName="a";
SMap.Marker.POI.fromXML=function(a){var c=SMap.Marker.fromXML.call(this,a);c.setSource(a.getAttribute("source"));c.setPlainId(a.getAttribute("id"));return c};SMap.Marker.POI.fromData=function(a){var c={title:a.title};a.paid&&(c.paid=a.paid);a.url&&(c.url=a.url);a.anchor&&(c.anchor=a.anchor);a.size&&(c.size=a.size);c=new this(SMap.Coords.fromWGS84(a.mark.lon,a.mark.lat),a.source+a.id,c);c.setSource(a.source);c.setPlainId(a.id);return c};
SMap.Marker.POI.VISUAL={BIG:{className:"big",size:[56,66],anchor:{left:28,top:63}},MIDDLE:{className:"middle",size:[44,56],anchor:{left:22,top:52}},UNIVERSAL:{className:"universal",size:[34,41],noImage:!0,anchor:{left:17,top:37}},SMALL:{className:"small",size:[34,41],anchor:{left:17,top:37}},SMALLER:{className:"smaller",size:[20,26],noImage:!0,anchor:{left:10,top:22}},LITTLE:{className:"little",size:[14,16],noImage:!0,anchor:{left:7,top:13}}};
SMap.Marker.POI._DETAILS=[{className:"detail",size:[58,68],makeFrom:["","big"],anchor:{left:29,top:65}},{className:"detailSmall",size:[46,56],makeFrom:["middle","small","smaller","little","universal"],anchor:{left:22,top:52}}];
SMap.Marker.POI.prototype.$constructor=function(a,c,b){this._visual={type:null,paid:!1,url:"",urlPoitype:"",detail:!1};b=b||{};b.url||b.urlPoitype||b.visual?!b.url&&b.visual&&(b.url=""):b.url=SMap.CONFIG.img+"/marker/empty-poi.png";!b.anchor&&b.size&&b.url&&(b.anchor={left:Math.round(b.size[0]/2),top:Math.round(b.size[1]/2)});this._cardOpts={cb:null,showTimeout:500,hideTimeout:250,rqTimeout:0,anchor:{left:0,top:0},hidden:!1};this._card={obj:null,hideID:null,showID:null,reqID:null,promiseStart:0,fill:!1};
this._me=[];this._sc=[];this._lastSignal=this._lastType="";this._lastAnchor={left:0,top:0};this._isMouseEnter=!1;this.$super(a,c,b);this._plainId=this._source=null};SMap.Marker.POI.prototype.$destructor=function(){this._clearShowTimeout();this._clearHideTimeout();this._clearRequestTimeout();this.$super()};SMap.Marker.POI.prototype.getVisual=function(){return this._visual};SMap.Marker.POI.prototype.setSource=function(a){this._source=a;this._updateAttributes();return this};
SMap.Marker.POI.prototype.getSource=function(){return this._source};SMap.Marker.POI.prototype.setPlainId=function(a){this._plainId=a;this._updateAttributes();return this};SMap.Marker.POI.prototype.getPlainId=function(){return this._plainId};SMap.Marker.POI.prototype.click=function(a,c){var b=this._dom.active;b&&"a"==b.nodeName.toLowerCase()&&SMap.Util.linkToNewWindow(a)||(a.preventDefault(),this.$super(a,c),this.getMap().getSignals().makeEvent("marker-poi-click",this,{event:a}))};
SMap.Marker.POI.prototype._updateAttributes=function(){var a=this._dom.active;a.setAttribute("data-log-action","card-poi");a.setAttribute("data-log-source",this._source);a.setAttribute("data-log-id",this._plainId);"a"==a.nodeName.toLowerCase()&&(a.href=SMap.CONFIG.mapyczDomain+"/?source="+this._source+"&id="+this._plainId)};
SMap.Marker.POI.prototype.setVisual=function(a){for(var c in a)this._visual[c]=a[c];this._me.length&&(JAK.Events.removeListeners(this._me),this._me=[]);a="";if(this._visual.detail||this._visual.type&&"object"===typeof this._visual.type){a=this._visual.type;if(this._visual.detail){c=a?a.className:"";for(var b,d=0;d<SMap.Marker.POI._DETAILS.length;d++){var e=SMap.Marker.POI._DETAILS[d];if(-1!=e.makeFrom.indexOf(c)){b=e;break}}a=b||a}b=JAK.mel(SMap.Marker.POI.nodeName,{className:"marker-poi"});b.classList.add(a.className);
c=JAK.mel("div",{className:"marker-inner"});d=JAK.mel("span",{className:"img-cont"});e=this._visual.urlPoitype||this._visual.url;"string"===typeof e?(0< !a.noImage&&e&&(e==this._visual.urlPoitype&&d.classList.add("poitype-icon"),d.style.backgroundImage="url({0})".replace("{0}",e),c.appendChild(d)),"borderRadius"in document.body.style||(b.classList.add("nbr"),c.appendChild(JAK.mel("span",{className:"nbr-cover"})))):(d.appendChild(e),c.appendChild(d));b.appendChild(c);this._options.size=a.size;this._options.anchor=
a.anchor;c="little"==a.className?-2:20-this._options.size[1];c+="small"==a.className?2:0;this._cardOpts.anchor.top=c;a=a.className}else this._visual.paid?(b=JAK.mel("a",{className:"marker-poi-paid paidPoiAnim"}),c=JAK.mel("div",{className:"marker-inner"}),a=new Image,a.src=this._visual.url,c.appendChild(a),b.appendChild(c),this._options.size=[34,40],this._options.anchor={left:17,top:37},this._cardOpts.anchor.top=20-this._options.size[1],a="paid"):(b=JAK.mel("a",{},{width:"20px",height:"20px",backgroundImage:"url("+
this._visual.url+")",backgroundRepeat:"no-repeat",backgroundPosition:"50% 50%"}),this._lastType&&"poi"!=this._lastType&&(this._options.size=[20,20],this._options.anchor={left:10,top:10}),this._options.size&&this._options.size.length&&(b.style.width=this._options.size[0]+"px",b.style.height=this._options.size[1]+"px"),this._cardOpts.anchor.top=this._options.size?Math.floor(this._options.size[1]/4):0,a="poi");this._options.title&&(b.title=this._options.title);this._dom.active=b;this._me.push(JAK.Events.addListener(b,
"mouseenter",this,"_mouseEnter"));this._me.push(JAK.Events.addListener(b,"mouseleave",this,"_mouseLeave"));(d=this._dom.container[SMap.LAYER_MARKER])&&d.parentNode&&1==d.parentNode.nodeType&&(b.style.position="absolute",e=parseFloat((d.style.left||"0").replace("px","")),c=parseFloat((d.style.top||"0").replace("px","")),e+=this._lastAnchor.left-this._options.anchor.left,c+=this._lastAnchor.top-this._options.anchor.top,b.style.left=e+"px",b.style.top=c+"px",d.parentNode.replaceChild(b,d));this._dom.container[SMap.LAYER_MARKER]=
b;this._lastAnchor.left=this._options.anchor.left;this._lastAnchor.top=this._options.anchor.top;this._lastType=a};SMap.Marker.POI.prototype._build=function(){var a={};this._options.visual&&(a.type=this._options.visual,a.urlPoitype=this._options.urlPoitype);this._options.paid&&(a.paid=!0);this._options.url&&(a.url=this._options.url);this._options.detail&&(a.detail=this._options.detail);this.setVisual(a)};
SMap.Marker.POI.prototype.setActive=function(a,c){var b=this._dom.active;this._visual.type&&!b.classList.contains("nbr")&&(b.classList[a?"add":"remove"]("active"),b.classList[c||!a&&!c?"remove":"add"]("animSize"))};SMap.Marker.POI.prototype.setPopupCallback=function(a){this._cardOpts.cb=a};SMap.Marker.POI.prototype.setCardOptions=function(a){for(var c in a)this._cardOpts[c]=a[c]};
SMap.Marker.POI.prototype.moveCard=function(){this._dom.active.classList.contains("active")&&this._card&&this._card.obj&&this.getMap().addCard(this._card.obj,this._getCardCoords(),!0)};
SMap.Marker.POI.prototype._mouseEnter=function(){this._isMouseEnter=!0;if(!this._cardOpts.cb&&!this._card.obj||this._card.obj&&this._cardOpts.hidden)this._makeSignal("marker-poi-enter");else{if(!this._card.obj){this._card.obj=new SMap.Card(null,{close:!1,anchor:this._cardOpts.anchor});var a=this._card.obj.getContainer();a.classList.add("marker-poi-popup");JAK.Events.addListener(a,"mouseenter",this,"_clearHideTimeout");JAK.Events.addListener(a,"mouseleave",this,"_popupLeave");this._sc.push(this.getMap().getSignals().addListener(this,
"zoom-start","_zoomStart"))}this._cardOpts.cb&&!this._card.fill&&(this._clearRequestTimeout(),this._card.reqID=setTimeout(function(){var a=this._cardOpts.cb.apply(this,[this._card.obj]);a instanceof JAK.Promise?(this._card.promiseStart=Date.now(),a.then(function(){if(this._isMouseEnter){var a=Date.now()-this._card.promiseStart;this._showCard(a<this._cardOpts.showTimeout?this._cardOpts.showTimeout-a:0)}this._card.fill=!0;this._card.promiseStart=0}.bind(this))):this._card.fill=!0;this._card.reqID=null}.bind(this),
this._cardOpts.rqTimeout));this._clearHideTimeout();this._card.promiseStart||this._showCard()}};SMap.Marker.POI.prototype._mouseLeave=function(a){this._clearRequestTimeout();this._card.obj?(a=a.relatedTarget||a.toElement)&&this._card.obj.getContainer().contains(a)||this._popupLeave():this._makeSignal("marker-poi-leave")};SMap.Marker.POI.prototype._clearShowTimeout=function(){this._card.showID&&(clearTimeout(this._card.showID),this._card.showID=null)};
SMap.Marker.POI.prototype._clearHideTimeout=function(){this._card.hideID&&(clearTimeout(this._card.hideID),this._card.hideID=null)};SMap.Marker.POI.prototype._clearRequestTimeout=function(){this._card.reqID&&(clearTimeout(this._card.reqID),this._card.reqID=null)};
SMap.Marker.POI.prototype._showCard=function(a){a="number"===typeof a?a:this._cardOpts.showTimeout;this._makeSignal("marker-poi-enter");this._clearShowTimeout();this._card.showID=setTimeout(function(){this._owner&&(this._dom.active.classList.add("active"),this.getMap().addCard(this._card.obj,this._getCardCoords(),!0))}.bind(this),a)};
SMap.Marker.POI.prototype._popupLeave=function(a){this._isMouseEnter=!1;a?(a=a.relatedTarget||a.toElement)&&(this._dom.active.contains(a)||this._makeSignal("marker-poi-leave")):this._makeSignal("marker-poi-leave");this._clearShowTimeout();this._clearHideTimeout();this._card.hideID=setTimeout(function(){this.removeCard()}.bind(this),this._cardOpts.hideTimeout)};
SMap.Marker.POI.prototype.removeCard=function(){this._owner&&(this._clearShowTimeout(),this._clearHideTimeout(),this._clearRequestTimeout(),this._dom.active.classList.remove("active"),this._card.obj&&this.getMap().getCard()==this._card.obj&&this.getMap().removeCard())};SMap.Marker.POI.prototype.setOwner=function(a){this._owner&&this._owner!=a&&(this.removeCard(),this.getMap()&&this.getMap().getSignals().removeListeners(this._sc));this.$super(a)};
SMap.Marker.POI.prototype._zoomStart=function(){this._card.obj&&this.removeCard()};SMap.Marker.POI.prototype._makeSignal=function(a){this._owner&&(a=a||"",this._lastSignal!=a&&(this.getMap().getSignals().makeEvent(a,this),this._lastSignal=a))};
SMap.Marker.POI.prototype._getCardCoords=function(){var a=this.getMap(),c=this.getCoords().toPixel(this.getMap()),b=this.getMap().getOffset(),d=parseFloat((this._dom.active.style.left||"0").replace("px",""))+this._options.anchor.left,e=parseFloat((this._dom.active.style.top||"0").replace("px",""))+this._options.anchor.top;return c.plus(new SMap.Pixel(d-(c.x+-1*b.x),e-(c.y+-1*b.y))).toCoords(a)};SMap.Marker.POI.prototype.isDetail=function(){return!!this._visual.detail};
SMap.Marker.FotoPOI=JAK.ClassMaker.makeClass({NAME:"SMap.Marker.FotoPOI",VERSION:"1.0",EXTEND:SMap.Marker.POI});SMap.Marker.FotoPOI.ICON_SIZE=25;SMap.Marker.FotoPOI.prototype.BACKGROUND_SRC=SMap.CONFIG.img+"/bg_foto_stin.png";SMap.Marker.FotoPOI.fromXML=SMap.Marker.POI.fromXML;SMap.Marker.FotoPOI.fromData=SMap.Marker.POI.fromData;SMap.Marker.FotoPOI.prototype.$constructor=function(a,c,b){var d=b||{};d.anchor||(d.anchor={left:15,top:15});this.$super(a,c,b)};
SMap.Marker.FotoPOI.prototype._build=function(){var a=JAK.mel("div",{title:this._options.title}),c=JAK.mel("img",{alt:"",src:this.BACKGROUND_SRC},{position:"absolute",top:0,left:0,width:"33px",height:"33px"}),b=JAK.mel("a"),d=SMap.CDN.setSize(this._options.url,SMap.CDN.SIZE_40_40),d=JAK.mel("img",{alt:"",src:d},{position:"absolute",top:"1px",left:"1px",border:"1px solid white",width:SMap.Marker.FotoPOI.ICON_SIZE+"px",height:SMap.Marker.FotoPOI.ICON_SIZE+"px"});b.appendChild(d);a.appendChild(c);a.appendChild(b);
this._dom.link=b;this._dom.container[SMap.LAYER_MARKER]=a;this._dom.active=this._dom.container[SMap.LAYER_MARKER];this._updateLink()};SMap.Marker.FotoPOI.prototype.setPlainId=function(a){this._plainId=a;this._updateLink();return this};SMap.Marker.FotoPOI.prototype.setSource=function(a){this._source=a;this._updateLink();return this};
SMap.Marker.FotoPOI.prototype._updateLink=function(){var a="#";this._source&&this._plainId&&(a=SMap.CONFIG.mapyczDomain+"/?source="+this._source+"&id="+this._plainId);this._dom.link.href=a};SMap.Marker.TrafficDetail=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.TrafficDetail",VERSION:"1.0",EXTEND:SMap.Marker});SMap.Marker.TrafficDetail.fromData=function(a){return new this(null,null,a)};SMap.Marker.TrafficDetail.prototype.$constructor=function(a,c,b){this.$super(a,c,b)};
SMap.Marker.TrafficDetail.prototype._build=function(){this._dom.container[SMap.LAYER_MARKER]=JAK.mel("div",{className:"traffic-geom-detail"});var a=JAK.mel("div",{className:"traffic-detail-content"}),c=JAK.mel("h5",{innerHTML:this._options.title}),b=JAK.mel("p"),d=JAK.mel("p"),e=JAK.mel("p"),f=JAK.mel("span");f.style.backgroundColor=this._options.loadColor;this._dom.container[SMap.LAYER_MARKER].appendChild(a);c=[a,f,c,b,d,e];"delay"in this._options&&(b.innerHTML=this._makeDelayText());"actSpeed"in
this._options&&"maxSpeed"in this._options&&(d.innerHTML=this._makeSpeedText());"load"in this._options&&(e.innerHTML=this._makeLoadText());JAK.DOM.append(c);SMap.CONFIG.debugMode&&(b=JAK.mel("em",{innerHTML:this._options.yearsOld}),b.style.cssText="color:blue;display:inline-block;margin-right:8px",d=JAK.mel("strong",{innerHTML:this._options.id},{position:"absolute",bottom:"0px",right:"0px",display:"block",padding:"3px",background:"#fff",color:"red"}),d.insertBefore(b,d.firstChild),a.appendChild(d))};
SMap.Marker.TrafficDetail.prototype._makeDelayText=function(){var a=this._options.delay;return"<strong>"+SMap._("trafficDetail.delay",{hours:Math.floor(a/3600),minutes:Math.ceil(a%3600/60)})+"</strong>"};SMap.Marker.TrafficDetail.prototype._makeSpeedText=function(){return SMap._("trafficDetail.speed",{actSpeed:this._options.actSpeed||0,maxSpeed:this._options.maxSpeed})};
SMap.Marker.TrafficDetail.prototype._makeLoadText=function(){return"object"==typeof this._options.load?this._options.load.value:SMap._("trafficDetail.load",{load:this._options.load})};SMap.Marker.TrafficDetail.prototype._formatCZPlural=function(a,c,b,d){var e=a+" ";return 1<a&&5>a?e+b:1==a?e+c:e+d};SMap.Geometry.Traffic=JAK.ClassMaker.makeClass({NAME:"SMap.Geometry.Traffic",VERSION:"1.0",EXTEND:SMap.Geometry.Multi});SMap.Geometry.Traffic.markerLayer=new SMap.Layer.Marker;
SMap.Geometry.Traffic.fromData=function(a){var c=SMap.Geometry.Multi.fromData.call(this,a);c.setData(a);return c};SMap.Geometry.Traffic._geometryFromData=SMap.Geometry.Multi._geometryFromData;
SMap.Geometry.Traffic._optionsFromData=function(a){var c={};a="object"==typeof a.extend.traffic.load?a.extend.traffic.load.original:a.extend.traffic.load;c.color=["#43ca00","#43ca00","#fab90c","#fa7200","#e51601"][a-1];c.outlineColor=["#cdfac1","#cdfac1","#fce7ae","#ffe0c6","#ffa3a3"][a-1];c.outlineWidth=2;c.opacity=1;c.outlineOpacity=1;c.title="";return c};
SMap.Geometry.Traffic.prototype.$constructor=function(a,c){this.$super(a,c);this._ec=[];this._timeout=null;this._offset=0;this._degree=null;this._running=!1;this._ts=this._marker=this._markerData=null};
SMap.Geometry.Traffic.prototype.setData=function(a){this._degree="object"==typeof a.extend.traffic.load?a.extend.traffic.load.original:a.extend.traffic.load;if(!this._marker){for(var c=["actSpeed","load","maxSpeed","delay"],b={},d=a.extend.traffic,e=0;e<c.length;e++){var f=c[e];f in d&&(b[f]=d[f])}b.title=a.title;b.loadColor=this._options.color;SMap.CONFIG.debugMode&&(b.id=a.id,b.yearsOld=a.yearsOld);this._markerData=b}};
SMap.Geometry.Traffic.prototype.$destructor=function(){this._running&&this._deactivate();this.$super()};SMap.Geometry.Traffic.prototype.click=function(){};SMap.Geometry.Traffic.prototype.draw=function(a,c){for(var b=this.getMap().getZoom(),b=Math.max(b,6),b=Math.min(b,16),b={width:{6:2,7:2,8:2,9:2,10:2,11:3,12:3,13:4,14:5,15:5,16:5}[b]},d=0;d<this._geometries.length;d++)this._geometries[d].setOptions(b);this.$super(a,c);this._addEvents()};
SMap.Geometry.Traffic.prototype.clear=function(){this._running&&this._deactivate();this._removeEvents();this.$super()};SMap.Geometry.Traffic.prototype._addEvents=function(){for(var a=this.getNodes(),c=0;c<a.length;c++){var b=a[c];this._ec.push(JAK.Events.addListener(b,"mouseover",this,"_mouseover"));this._ec.push(JAK.Events.addListener(b,"mouseout",this,"_mouseout"))}};SMap.Geometry.Traffic.prototype._removeEvents=function(){JAK.Events.removeListeners(this._ec)};
SMap.Geometry.Traffic.prototype._parseCoords=function(a){return this.$super(a)};
SMap.Geometry.Traffic.prototype._mouseover=function(a,c){if(!this._running){var b=this._markerData,d=SMap.Coords.fromEvent(a,this.getMap()),e=SMap.Pixel.fromEvent(a,this.getMap()),f={};0>e.x?f.left=-10:f.right=-10;0>e.y?f.top=-10:f.bottom=-10;b.anchor=f;this._marker=SMap.Marker.TrafficDetail.fromData(b);b=this._marker.getContainer()[SMap.LAYER_MARKER];this._ec.push(JAK.Events.addListener(b,"mouseover",this,"_mouseover"));this._ec.push(JAK.Events.addListener(b,"mouseout",this,"_mouseout"));this._marker.setCoords(d);
this._activate()}};SMap.Geometry.Traffic.prototype._mouseout=function(a,c){if(this._running){var b=a.relatedTarget||a.toElement;-1==this.getNodes().indexOf(b)&&b!=this._marker.getContainer()[SMap.LAYER_MARKER]&&this._deactivate()}};
SMap.Geometry.Traffic.prototype._activate=function(){this._ts=(new Date).getTime();this._step();this.constructor.markerLayer.addMarker(this._marker);this.constructor.markerLayer.isActive()||this.getMap().addLayer(this.constructor.markerLayer).enable();this.getNodes()[0].setAttribute("stroke-dasharray","10,10");this._running=!0;JAK.Timekeeper.getInstance().addListener(this,"_step",1)};
SMap.Geometry.Traffic.prototype._deactivate=function(){this.constructor.markerLayer.removeMarker(this._marker);this.constructor.markerLayer.isActive()&&(this.constructor.markerLayer.disable(),this.getMap().removeLayer(this.constructor.markerLayer));JAK.Timekeeper.getInstance().removeListener(this);this._running=null;for(var a=this.getNodes(),c=0;c<a.length;c++)a[c].setAttribute("stroke-dasharray","")};
SMap.Geometry.Traffic.prototype._step=function(){var a=(new Date).getTime(),c=(a-this._ts)/100*{1:6,2:5,3:4,4:2,5:1}[this._degree];Math.round(this._offset)!=Math.round(this._offset+c)&&(this._offset+=c,20<this._offset&&(this._offset-=20),this._ts=a,this.getNodes()[0].setAttribute("stroke-dashoffset",-Math.round(this._offset)))};SMap.LOOKUP_MARKER={base:SMap.Marker.POI,firm:SMap.Marker.POI,traf:SMap.Marker.POI,di:SMap.Marker.POI,foto:SMap.Marker.FotoPOI,pubt:SMap.Marker.POI};SMap.LOOKUP_GEOMETRY={rout:SMap.Geometry.Traffic};
